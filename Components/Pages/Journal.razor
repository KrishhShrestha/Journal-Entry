@page "/journal"
@inject Journal_Entry.ViewModels.JournalViewModel VM
@using Syncfusion.Blazor.RichTextEditor
@using System.Text.RegularExpressions

<style>
    .journal-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        color: white;
        font-size: 2.4rem;
        font-weight: 700;
    }

    .date-display {
        color: rgba(255,255,255,0.9);
    }

    .two-column-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .journal-card {
        background: white;
        border-radius: 18px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .card-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 1.2rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.6rem;
    }

    .input-group-modern {
        margin-bottom: 1.2rem;
    }

    .input-label {
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.4rem;
        display: block;
    }

    .input-modern {
        width: 100%;
        padding: 0.8rem;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
    }

    .editor-wrapper {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
    }

    .mood-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .mood {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .mood.selected {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .save-btn {
        width: 100%;
        padding: 1rem;
        background: #667eea;
        border: none;
        color: white;
        font-weight: bold;
        border-radius: 10px;
        cursor: pointer;
    }

    .entry-content {
        background: #f7fafc;
        padding: 1rem;
        border-radius: 10px;
        line-height: 1.7;
    }

    @@media (max-width: 900px) {
        .two-column-layout {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="journal-container">

    <!-- HEADER -->
    <div class="page-header">
        <h1>✨ Today's Journal</h1>
        <div class="date-display">
            @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
        </div>
    </div>

    <div class="two-column-layout">

        <!-- LEFT: CREATE ENTRY -->
        <div class="journal-card">
            <div class="card-title">Create Entry</div>

            <div class="input-group-modern">
                <label class="input-label">Title</label>
                <input class="input-modern" @bind="VM.Title" placeholder="Give your day a title..." />
            </div>

            <div class="input-group-modern">
                <label class="input-label">Your Story</label>
                <div class="editor-wrapper">
                    <SfRichTextEditor
                        @bind-Value="VM.Content"
                        Height="260px"
                        Enabled="true"
                        ShowTooltip="false"
                        Placeholder="Write about your day...">

                        <RichTextEditorToolbarSettings>
                            <RichTextEditorToolbarItems Items="ToolbarItems" />
                        </RichTextEditorToolbarSettings>

                    </SfRichTextEditor>
                </div>
            </div>

            <div class="input-group-modern">
                <label class="input-label">Mood</label>
                <div class="mood-selector">
                    @foreach (var mood in Moods)
                    {
                        <div class="mood @(VM.PrimaryMood == mood.Name ? "selected" : "")"
                             @onclick="() => VM.PrimaryMood = mood.Name"
                             title="@mood.Name">
                            @mood.Emoji
                        </div>
                    }
                </div>
            </div>

            <div class="input-group-modern">
                <label class="input-label">Tags</label>
                <input class="input-modern" @bind="VM.Tags" placeholder="work, personal, gratitude" />
            </div>

            <button class="save-btn" @onclick="Save">
                💾 Save Entry
            </button>
        </div>

        <!-- RIGHT: SAVED ENTRY -->
        <div class="journal-card">
            <div class="card-title">Saved Entry</div>

            @if (VM.TodayEntry != null)
            {
                <h3>@VM.TodayEntry.Title</h3>

                <div class="entry-content">
                    @((MarkupString)VM.TodayEntry.Content)
                </div>

                <p><b>Mood:</b> @VM.TodayEntry.PrimaryMood</p>
                <p><b>Tags:</b> @VM.TodayEntry.Tags</p>
            }
            else
            {
                <p>No entry saved yet.</p>
            }
        </div>

    </div>
</div>

@code {

    List<ToolbarItemModel> ToolbarItems = new()
    {
        new ToolbarItemModel { Command = ToolbarCommand.Bold },
        new ToolbarItemModel { Command = ToolbarCommand.Italic },
        new ToolbarItemModel { Command = ToolbarCommand.Underline },
        new ToolbarItemModel { Command = ToolbarCommand.OrderedList },
        new ToolbarItemModel { Command = ToolbarCommand.UnorderedList },
        new ToolbarItemModel { Command = ToolbarCommand.CreateLink }
    };

    List<(string Name, string Emoji)> Moods = new()
    {
        ("Happy","😊"),
        ("Calm","😌"),
        ("Sad","😢"),
        ("Anxious","😰"),
        ("Grateful","🙏"),
        ("Motivated","💪")
    };

    void Save()
    {
        VM.Content = CleanHtml(VM.Content);

        if (string.IsNullOrWhiteSpace(VM.Content))
            return;

        VM.SaveEntry();

        VM.Title = "";
        VM.Content = "";
        VM.PrimaryMood = "";
        VM.Tags = "";
    }

    string CleanHtml(string html)
    {
        if (string.IsNullOrWhiteSpace(html))
            return "";

        html = Regex.Replace(
            html,
            "<richtexteditortoolbaritems[\\s\\S]*?</richtexteditortoolbaritems>",
            "",
            RegexOptions.IgnoreCase
        );

        html = html.Replace("<p><br></p>", "").Trim();

        return html;
    }
}
